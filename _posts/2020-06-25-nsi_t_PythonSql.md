---
keywords: fastai
description: Cours NSI Terminale - Thème 2.
title: Bases de données avec Python
toc: true 
badges: true
comments: false
categories: [python,  NSI,   Terminale,   Bases de données,   SQL,   TP]
image: /images/nsi2.png
nb_path: _notebooks/2020-06-25-nsi_t_PythonSql.ipynb
layout: notebook
---

<!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-06-25-nsi_t_PythonSql.ipynb
-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Exploiter-une-base-de-donn&#233;es-avec-Python">Exploiter une base de donn&#233;es avec Python<a class="anchor-link" href="#Exploiter-une-base-de-donn&#233;es-avec-Python"> </a></h2><p>Dans ce TP, nous allons reprendre notre base de données d'exemples sur les livres, mais nous allons utiliser Python pour exécuter et exploiter les requêtes SQL. Notre SGBD sera toujours SQLite : le module python que nous utiliserons se nomme <strong>sqlite3</strong>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Le module étant importé, nous devons réaliser deux actions pour pouvoir commencer à utiliser notre base :</p>
<ul>
<li>ouvrir le fichier de base de données</li>
<li>créer un curseur</li>
</ul>
<p>Le <em>curseur</em> est un objet python offrant des méthodes pour exécuter des requêtes et récupérer le ou les résultats de ces requêtes.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bdd</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;livres_db&quot;</span><span class="p">)</span>
<span class="n">curseur</span> <span class="o">=</span> <span class="n">bdd</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><em>livres_db</em> est le nom du fichier contenant la base de donnéees SQLite que nous allons exploiter. Si le fichier n'existe pas, une nouvelle base de données sera créée.</p>
<h2 id="Ex&#233;cuter-des-requ&#234;tes-de-s&#233;lection">Ex&#233;cuter des requ&#234;tes de s&#233;lection<a class="anchor-link" href="#Ex&#233;cuter-des-requ&#234;tes-de-s&#233;lection"> </a></h2><h3 id="Le-principe">Le principe<a class="anchor-link" href="#Le-principe"> </a></h3><p>Reste ensuite à exécuter notre première requête. Pour cela, nous utiliserons la méthode <strong>execute()</strong> du curseur, la requête étant une chaîne de caractères passée en paramètre.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">requete</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM Livres;&quot;</span>
<span class="n">curseur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">requete</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Pour visualiser le résultat de notre requête, nous utiliserons encore notre curseur. Deux méthodes permettent principalement de le faire :</p>
<ul>
<li><strong>fetchone()</strong> pour récupérer un résultat puis avancer le curseur d'un cran</li>
<li><strong>fetchall()</strong> pour récupérer d'un coup tous les résultats. </li>
</ul>
<p>Regardez les exemples ci-dessous pour mieux comprendre comment fonctionne le curseur : il s'agit littéralement d'un curseur que l'on déplace de résultat en résultat. Vous vous en rendrez compte en exécutant plusieurs fois la cellule ci-dessous.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">curseur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Vous constatez que le résultat est un <em>tuple</em>  dont les éléments correspondent aux attributs sélectionnés : ici c'est *. Il n'est pas facile de se rappeler de l'ordre des attributs. Pour cela vous pouvez faire appel à la propriété :</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">curseur</span><span class="o">.</span><span class="n">description</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>et pour rendre la réponse plus lisible, une petite liste en compréhension ;). Et voilà les attributs de colonne en clair dans l'ordre ou ils apparaissent dans le résultat de la requête !</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">curseur</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A présent, le fonctionnement de <strong>fetchall()</strong> ne devrait pas vous étonner : on récupère logiquement un tuple avec tous les résultats.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">curseur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Si vous avez suivi les instructions précédentes, vous devriez constater qu'il manque des enregistrements. Pourquoi ?
Un indice : si vous réexécutez une nouvelle fois la méthode <strong>fetchall()</strong> du curseur, celle-ci ne renverra rien !</p>
<p>Et oui, c'est la notion de curseur qui se déplace au fur à mesure qu'unb résultat est donné : les précédents appels de <strong>fetchone()</strong> ont fait avancer le curseur, et de même, <strong>fetchall()</strong> positionne le curseur à la toute fin.</p>
<p>Pour retrouver tous les résultats à nouveau, il faut réexécuter la requête. Evitez donc de mélanger <strong>fetchone()</strong> et <strong>fetchall()</strong> sous peine de ne plus trop savoir ou en est le curseur et ce que vous récupérez.</p>
<p>Voici donc le moyen le plus simple de récupérer tous les résultats d'une requête d'un coup.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">curseur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">requete</span><span class="p">)</span>
<span class="n">resultats</span> <span class="o">=</span> <span class="n">curseur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="n">resultats</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Construire-des-requ&#234;tes-&#224;-partir-de-variables-python">Construire des requ&#234;tes &#224; partir de variables python<a class="anchor-link" href="#Construire-des-requ&#234;tes-&#224;-partir-de-variables-python"> </a></h3><p>Nous allons dans l'exemple suivant écrire une fonction <strong>prenom()</strong></p>
<ul>
<li>qui prend en paramètre un curseur et un nom d'auteur</li>
<li>qui renvoie son prénom</li>
</ul>
<p>Si le nom de l'auteur ne figure pas dans la table <em>Auteurs</em>, la fonction renverra <strong>None</strong>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">prenom</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">nom</span><span class="p">):</span>
    <span class="n">requete</span> <span class="o">=</span> <span class="s2">&quot;select PrenomAuteur from Auteurs where NomAuteur = ?&quot;</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">requete</span><span class="p">,</span> <span class="p">[</span><span class="n">nom</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">prenom</span><span class="p">(</span><span class="n">curseur</span><span class="p">,</span> <span class="s2">&quot;Verne&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Explications">Explications<a class="anchor-link" href="#Explications"> </a></h3><p>Dans cet exemple, nous construisons une requête à partir d'une variable Python. SQLite propose un mécanisme de substitution sécurisé permettant d'injecter une ou plusieurs variables à l'intérieur d'une requête. <strong>C'est ce mécanisme que vous devez utiliser</strong> : ne construisez pas vous même la chaîne de caractère contenant la requête complète, c'est une mauvaise pratique qui vous conduira inévitablement à des problèmes.</p>
<p>Pour utiliser ce mécanisme de substitution, vous devez</p>
<ul>
<li>mettre des <strong>?</strong> dans votre requête à l'emplacement de la variable à insérer</li>
<li>passer en second paramètre la liste des valeurs à substituer dans la requête</li>
</ul>
<p>C'est simple, fiable et sécurisé, en particulier contre les <a href="https://xkcd.com/327/">injections SQL</a> !</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="A-vous-de-jouer">A vous de jouer<a class="anchor-link" href="#A-vous-de-jouer"> </a></h3><p>Ecrivez une fonction <strong>romans()</strong></p>
<ul>
<li>qui prend en paramètre un curseur et un nom d'auteur</li>
<li>qui renvoie une liste de <em>Titres</em> de romans écrits par cet auteur</li>
</ul>
<p>Si le nom de l'auteur ne figure pas dans la table <em>Auteurs</em>, la fonction renverra <strong>None</strong>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">romans</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">nom</span><span class="p">):</span>
    <span class="c1"># YOUR CODE HERE</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">romans</span><span class="p">(</span><span class="n">curseur</span><span class="p">,</span> <span class="s2">&quot;Asimov&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;Fondation&#39;</span><span class="p">,</span> <span class="s1">&#39;Les Robots&#39;</span><span class="p">,</span> <span class="s1">&#39;La Fin de l’éternité&#39;</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">romans</span><span class="p">(</span><span class="n">curseur</span><span class="p">,</span> <span class="s2">&quot;Verne&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;De la Terre à la Lune&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Ins&#233;rer-de-nouveaux-enregistrements">Ins&#233;rer de nouveaux enregistrements<a class="anchor-link" href="#Ins&#233;rer-de-nouveaux-enregistrements"> </a></h2><p>Les requêtes de modification sur la base se font de la même manière que les requêtes de sélection, à une petite subtilité près : après exécution de la requête, il faudra faire appel à la méthode <strong>commit()</strong> de l'objet <em>bdd</em> (issu de la connexion) afin que les modifications soient prises en compte dans le fichier de base de données.</p>
<p><strong>Attention</strong> : Si vous oubliez l'appel à commit, vos modifications seront perdues lorsque vous quitterez votre programme car elles ne seront pas inscrites dans le fichier de la base de données.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">requete</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">INSERT INTO Auteurs </span>
<span class="s2">  (NomAuteur, PrenomAuteur, IdLangue, AnneeNaissance)</span>
<span class="s2">VALUES</span>
<span class="s2">  (&#39;Lecluse&#39;, &#39;Olivier&#39;, 2, 1870);</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">curseur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">requete</span><span class="p">)</span>
<span class="n">bdd</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>la propriété <strong>lastrowid</strong> peut être intéressante car elle donne accès à la clé primaire créée automatiquement pour notre nouvel enregistrement. En voici une utilisation :</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">last_id</span> <span class="o">=</span> <span class="n">curseur</span><span class="o">.</span><span class="n">lastrowid</span>
<span class="n">last_id</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">requete</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM Auteurs WHERE IdAuteur = ?&quot;</span>
<span class="n">curseur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">requete</span><span class="p">,</span> <span class="p">[</span><span class="n">last_id</span><span class="p">])</span>
<span class="n">curseur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="A-vous-de-jouer">A vous de jouer<a class="anchor-link" href="#A-vous-de-jouer"> </a></h3><p>Effacez de la table auteur ce dernier enregistrement que nous avons créé.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">requete</span> <span class="o">=</span> <span class="s2">&quot;SELECT COUNT(*) from Auteurs&quot;</span>
<span class="n">curseur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">requete</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">curseur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">curseur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from Auteurs&quot;</span><span class="p">)</span>
<span class="n">curseur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Pour-Finir">Pour Finir<a class="anchor-link" href="#Pour-Finir"> </a></h2><p>Notre travail sur la BDD exemple est à présent terminé. Afin de fermer le fichier proprement et de s'assurer que les données saisies seront bien inscrites dans le fichier, il faut <em>impérativement</em> appeler la méthode <strong>close()</strong> sur l'objet <em>bdd</em> :</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bdd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">curseur</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A partir de ce moment là, plus acune opération n'est possible sur la base de données comme le montre la cellule suivante :</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">requete</span> <span class="o">=</span> <span class="s2">&quot;SELECT COUNT(*) from Auteurs&quot;</span>
<span class="n">curseur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">requete</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

