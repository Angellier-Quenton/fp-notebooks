---
keywords: fastai
description: Communication client/serveur avec utilisation de threads
title: Utilisation de threads avec le réseau
toc: true
badges: true
comments: false
categories: [python, ISN]
nb_path: _notebooks/2020-03-07-Python8 - Reseau Threads.ipynb
layout: notebook
---

<!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-03-07-Python8 - Reseau Threads.ipynb
-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">socket</span>
<span class="c1"># en plus de socket, on utilise les threads</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>

<span class="c1"># fonction qui va gérer un client (boucle avec sortie si &#39;exit&#39; reçu)</span>
<span class="c1"># cette fonction sera appelée dans un nouveau thread à chaque connexion</span>

<span class="k">def</span> <span class="nf">gereClient</span><span class="p">(</span><span class="n">sockclient</span><span class="p">,</span><span class="n">addr</span><span class="p">):</span>
    <span class="n">sock</span><span class="o">=</span><span class="n">sockclient</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUFSIZ</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;Utf8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s1">&#39;exit&#39;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;echo : &#39;</span> <span class="o">+</span> <span class="n">data</span> <span class="c1"># notre serveur est tjs le même</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;Utf8&quot;</span><span class="p">))</span>
        
    <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;FIN&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;Utf8&quot;</span><span class="p">))</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">BUFSIZ</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="c1">#HOST = socket.gethostname()</span>
<span class="n">HOST</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span> <span class="c1"># Toutes les addresses de la machine à l&#39;écoute</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">4567</span>
<span class="n">ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
<span class="n">sockserveur</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
<span class="n">sockserveur</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">ADDR</span><span class="p">)</span>
<span class="c1"># on peut éventuellement mettre un paramètre plus grand à listen</span>
<span class="c1"># si on veut que le serveur ne refuse pas une connexion</span>
<span class="c1"># alors qu&#39;il est en train d&#39;en traiter une autre</span>
<span class="c1"># (temps de passage de la connexion à un nouveau thread)</span>
<span class="n">sockserveur</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># boucle pour les connexions des clients, sans fin</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Serveur à l&#39;écoute…&quot;</span><span class="p">)</span>
    <span class="n">sockclient</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">sockserveur</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;...connexion de : &#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
    <span class="c1"># quand un client se connecte, on crée un thread &quot;pour lui&quot; </span>
    <span class="c1"># contenant la fonction de gestion de client</span>
    <span class="n">th</span><span class="o">=</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">gereClient</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">sockclient</span><span class="p">,</span><span class="n">addr</span><span class="p">))</span>
    <span class="n">th</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Explications">Explications<a class="anchor-link" href="#Explications"> </a></h2><p>La commande de reception de donnée depuis le réseau est</p>
<p><PRE>sock.recv(BUFSIZ).decode("Utf8")</PRE>
Cette commande est <strong><em>bloquante</em></strong>, ce qui signifie que lorsque le serveur est en attente d'un message en provenance d'un client, il ne peut rien faire d'autre, en particulier, il ne peut pas traiter les demandes d'autres clients éventuels.</p>
<p>Cette situation est bien sûr intenable dans le cadre d'un usage classique. Pour contourner cette difficulté, nous intégrons cette commande bloquante dans une fonction qui sera exécutée en <strong><em>parallèle</em></strong> du programme principal qui restera disponible pour traiter les autres connexions clients.</p>
<p>Pour exécuter une fonction en parallèle, on fait appel à la librairie <strong><em>Threading</em></strong> de Python : Un thread étant un morceau de programme s'éxécutant en parallèle du programme qui l'appelle. Nous créons donc grâce à la commande</p>
<p><PRE>Thread(target=gereClient,args=(sockclient,addr))</PRE>
un appel non bloquant à la fonction gereClient, et ce pour chaque client qui se connecte.</p>
<p>Nous pouvons donc traiter simultanément la connexion de plusieurs clients au même serveur.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Le-client">Le client<a class="anchor-link" href="#Le-client"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>

<span class="n">liaison</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="c1"># socket client</span>

<span class="k">def</span> <span class="nf">gestionClient</span><span class="p">():</span>
    <span class="c1"># Communication client exécuté en parallèle dans un thread</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span> 
    <span class="k">while</span> <span class="n">message</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;FIN&quot;</span> <span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">liaison</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span> <span class="c1"># Commande bloquante</span>
        <span class="n">listeMsg</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">END</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="c1"># On affiche le message reçu</span>
        
    <span class="n">etatStr</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;Connexion terminée.&quot;</span> <span class="p">)</span>
    <span class="n">liaison</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">connect</span><span class="p">():</span>
    <span class="n">SERVEUR</span><span class="o">=</span><span class="n">ipAddr</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">PORT</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="n">ipPort</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">liaison</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">SERVEUR</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
        <span class="n">etatStr</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;Connexion établie&quot;</span><span class="p">)</span>
        <span class="n">th</span><span class="o">=</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">gestionClient</span><span class="p">)</span>
        <span class="n">th</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">etatStr</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;La connexion a échoué.&quot;</span><span class="p">)</span>
        <span class="n">liaison</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">envoi</span><span class="p">():</span>
    <span class="n">liaison</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msgStr</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
    <span class="n">msgStr</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    
<span class="n">fenetre</span><span class="o">=</span><span class="n">Tk</span><span class="p">()</span>
<span class="n">fenetre</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Client réseau&quot;</span>

<span class="c1">## textes variables</span>
<span class="n">ipAddr</span><span class="o">=</span><span class="n">StringVar</span><span class="p">()</span>
<span class="n">ipAddr</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">)</span>
<span class="n">ipPort</span><span class="o">=</span><span class="n">StringVar</span><span class="p">()</span>
<span class="n">ipPort</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;4567&quot;</span><span class="p">)</span>
<span class="n">etatStr</span><span class="o">=</span><span class="n">StringVar</span><span class="p">()</span>
<span class="n">etatStr</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;Etat de la connection...&quot;</span><span class="p">)</span>
<span class="n">msgStr</span><span class="o">=</span><span class="n">StringVar</span><span class="p">()</span>

<span class="c1">## Interface graphique</span>
<span class="n">connFrame</span><span class="o">=</span><span class="n">Frame</span><span class="p">(</span><span class="n">fenetre</span><span class="p">,</span><span class="n">bd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">relief</span><span class="o">=</span><span class="n">SUNKEN</span><span class="p">)</span> <span class="c1"># Cadre de connection</span>
<span class="n">msgFrame</span><span class="o">=</span><span class="n">Frame</span><span class="p">(</span><span class="n">fenetre</span><span class="p">,</span><span class="n">bd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">relief</span><span class="o">=</span><span class="n">SUNKEN</span><span class="p">)</span> <span class="c1"># Cadre d&#39;envoi</span>
<span class="n">ipEntry</span><span class="o">=</span><span class="n">Entry</span><span class="p">(</span><span class="n">connFrame</span><span class="p">,</span><span class="n">textvariable</span><span class="o">=</span><span class="n">ipAddr</span><span class="p">)</span>
<span class="n">portEntry</span><span class="o">=</span><span class="n">Entry</span><span class="p">(</span><span class="n">connFrame</span><span class="p">,</span><span class="n">textvariable</span><span class="o">=</span><span class="n">ipPort</span><span class="p">)</span>
<span class="n">btnConnect</span><span class="o">=</span><span class="n">Button</span><span class="p">(</span><span class="n">connFrame</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Connexion&quot;</span><span class="p">,</span><span class="n">command</span><span class="o">=</span><span class="n">connect</span><span class="p">)</span>
<span class="n">etatLbl</span><span class="o">=</span><span class="n">Label</span><span class="p">(</span><span class="n">fenetre</span><span class="p">,</span><span class="n">textvariable</span><span class="o">=</span><span class="n">etatStr</span><span class="p">)</span>
<span class="n">listeMsg</span> <span class="o">=</span> <span class="n">Listbox</span><span class="p">(</span><span class="n">fenetre</span><span class="p">)</span>
<span class="n">msgLbl</span><span class="o">=</span><span class="n">Label</span><span class="p">(</span><span class="n">msgFrame</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Message&quot;</span><span class="p">)</span>
<span class="n">msgEntry</span><span class="o">=</span><span class="n">Entry</span><span class="p">(</span><span class="n">msgFrame</span><span class="p">,</span><span class="n">textvariable</span><span class="o">=</span><span class="n">msgStr</span><span class="p">)</span>
<span class="n">msgSend</span><span class="o">=</span><span class="n">Button</span><span class="p">(</span><span class="n">msgFrame</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Envoyer&quot;</span><span class="p">,</span><span class="n">command</span><span class="o">=</span><span class="n">envoi</span><span class="p">)</span>

<span class="c1">## positionnement des widgets</span>
<span class="n">connFrame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">ipEntry</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">,</span><span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">portEntry</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">,</span><span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">btnConnect</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">,</span><span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">etatLbl</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">listeMsg</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">msgFrame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">msgLbl</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">,</span><span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">msgEntry</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">,</span><span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">msgSend</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">LEFT</span><span class="p">,</span><span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">fenetre</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Explications">Explications<a class="anchor-link" href="#Explications"> </a></h2><p>Dans ce programme client, la majeure partie correspond au design de l'interface graphique. Nous utilisons ici le widget <strong><em>Frame</em></strong> de TKinter permettant de créer des zones dans l'interface dans laquelle la mise en page sera différente :</p>
<p><PRE>pack(side=LEFT,padx=5,pady=5)</PRE>
permet de placer les composants les un à coté des autres dans les différents cadres. Les cadres eux même sont disposés avec la disposition par défaut c'est à dire verticalement.</p>
<p>La problématique principale de ce programme est de gérer à la fois l'écoute de messages en provenance du serveur et la réactivité de l'interface graphique. En effet, la commande</p>
<p><PRE>message = liaison.recv(1024).decode("utf8")</PRE>
est bloquante, ce qui signifie que quand le client est en attente d'un message du serveur, il ne peut rien faire d'autre. En particulier, il ne peut pas réagir aux événements en provenance de l'utilisateur sur l'interface graphique. L'application est alors figée.</p>
<p>Pour se prémunir de ce problème, comme pour le serveur, nous devrons intégrer la commande de reception de message dans un <strong><em>Thread</em></strong> dédié qui tournera en parallèle de notre programme qui sera alors en capacité de gérer l'interface graphique.</p>
<p>Pour ce faire, dès que le client se connecte au serveur on crée un <strong><em>thread</em></strong> par la commande</p>
<p><PRE>Thread(target=gestionClient)</PRE>
qui sera en charge de receotionner les messages du serveur et de les afficher dans la zone de texte (<strong><em>Listbox</em></strong>)</p>

</div>
</div>
</div>
</div>
 

